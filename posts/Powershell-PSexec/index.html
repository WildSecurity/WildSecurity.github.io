<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Powershell and PSExec" /><meta property="og:locale" content="en" /><meta name="description" content="Today we investigate some strange behaviour from a (possibly user) executed Powershell session." /><meta property="og:description" content="Today we investigate some strange behaviour from a (possibly user) executed Powershell session." /><link rel="canonical" href="https://wilddogone.github.io//posts/Powershell-PSexec/" /><meta property="og:url" content="https://wilddogone.github.io//posts/Powershell-PSexec/" /><meta property="og:site_name" content="About Security" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-05-17T21:39:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Powershell and PSExec" /><meta name="twitter:site" content="@none" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-05-17T21:39:00+02:00","datePublished":"2022-05-17T21:39:00+02:00","description":"Today we investigate some strange behaviour from a (possibly user) executed Powershell session.","headline":"Powershell and PSExec","mainEntityOfPage":{"@type":"WebPage","@id":"https://wilddogone.github.io//posts/Powershell-PSexec/"},"url":"https://wilddogone.github.io//posts/Powershell-PSexec/"}</script><title>Powershell and PSExec | About Security</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="About Security"><meta name="application-name" content="About Security"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/avatar.png " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">About Security</a></div><div class="site-subtitle font-italic">Blue and Red</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/WildDogOne" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/none" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['example','doamin.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Powershell and PSExec</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Powershell and PSExec</h1><div class="post-meta text-muted"><div> By <em> <a href="https://github.com/WildDogOne/">WildDogOne</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1652816340" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-05-17 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1069 words"> <em>5 min</em> read</span></div></div></div><div class="post-content"><p>Today we investigate some strange behaviour from a (possibly user) executed Powershell session.</p><h2 id="the-alert"><span class="mr-2">The Alert</span><a href="#the-alert" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p><img data-src="/assets/img/posts/2022-05-17/storyline_start.jpg" alt="storyline" data-proofer-ignore></p><p>Everything started with an explorer.exe running the following commandline.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="s2">"cmd.exe"</span><span class="w"> </span><span class="n">/c</span><span class="w"> </span><span class="nx">echo</span><span class="o">|</span><span class="n">set/p</span><span class="o">=</span><span class="s2">"C:\Temp\Tools"</span><span class="o">|</span><span class="n">powershell</span><span class="w"> </span><span class="nt">-NoP</span><span class="w"> </span><span class="nt">-W</span><span class="w"> </span><span class="nx">1</span><span class="w"> </span><span class="nt">-NonI</span><span class="w"> </span><span class="nt">-NoL</span><span class="w"> </span><span class="s2">"SaPs 'cmd' -Args '/c """</span><span class="nx">cd</span><span class="w"> </span><span class="nx">/d</span><span class="s1">',$([char]34+$Input+[char]34),'</span><span class="err">^</span><span class="o">&amp;</span><span class="err">^</span><span class="o">&amp;</span><span class="w"> </span><span class="nx">start</span><span class="w"> </span><span class="nx">/b</span><span class="w"> </span><span class="nx">cmd.exe</span><span class="s2">"""' -Verb RunAs"</span><span class="w">
</span></pre></table></code></div></div><p>When explorer.exe starts something, this usually means that a user started this with a run command. However, as there are ways to obfuscate this by for example running cmd like this <code class="language-plaintext highlighter-rouge">explorer.exe /root,"C:\Windows\System32\cmd.exe"</code></p><p>Let’s first inspect the commandline though, it seems to switch the execution path to C:\Temp\Tools and elevate to administrative rights. I always like to first get a handle on the parameters used to run powershell.</p><div class="table-wrapper"><table><thead><tr><th style="text-align: left">Parameter<th style="text-align: left">Parameter Full<th style="text-align: left">Explanation<tbody><tr><td style="text-align: left">-NoP<td style="text-align: left">-NoProfile<td style="text-align: left">Who would do that? Doesn’t really have a negative impact though<tr><td style="text-align: left">-W 1<td style="text-align: left">-WindowStyle 1<td style="text-align: left">Strange param because usually one would see “Normal, Minimized, Maximized or Hidden” no numbers<tr><td style="text-align: left">-NonI<td style="text-align: left">-NonInteractive<td style="text-align: left">Makes the session non interactive, which is of course interesting<tr><td style="text-align: left">-NoL<td style="text-align: left">-NoLogo<td style="text-align: left">Removes the Logo of session, no real impact</table></div><p>The <code class="language-plaintext highlighter-rouge">-W 1</code> param is definitely fancy for me, usually one would expect <code class="language-plaintext highlighter-rouge">-W Hidden</code>, but it seems like it accomplishes the same job.</p><p>So far my verdict is, the user executed this process, which makes it more or less legitimate, but the params are strange, so I cannot say a direct false or true positive right now. Because of this, we need to dig deeper.</p><h2 id="hunting-deeper"><span class="mr-2">Hunting deeper</span><a href="#hunting-deeper" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>In MDE we can also see the following alerts: <img data-src="/assets/img/posts/2022-05-17/alerts.jpg" alt="alerts" data-proofer-ignore></p><p>But there is exactly no information on why MDE thinks that there is suspicious discovery going on. Because of this I decided to check if there were new processes spawned after the admin cmd.exe via advanced hunting. For this we take the PID and timeframe of execution and of course the device the execution happened on.</p><p>Example script:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="n">let</span><span class="w"> </span><span class="nx">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"1234"</span><span class="p">;</span><span class="w">
</span><span class="n">let</span><span class="w"> </span><span class="nx">device</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"mydevice"</span><span class="p">;</span><span class="w">
</span><span class="n">let</span><span class="w"> </span><span class="nx">time_span</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">datetime</span><span class="p">(</span><span class="mi">2022</span><span class="nt">-01-01T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">);</span><span class="w">
</span><span class="n">DeviceProcessEvents</span><span class="w">
</span><span class="o">|</span><span class="w"> </span><span class="n">where</span><span class="w"> </span><span class="nx">Timestamp</span><span class="w"> </span><span class="nx">between</span><span class="w"> </span><span class="p">(</span><span class="n">time_span</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="p">(</span><span class="n">time_span</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">1d</span><span class="p">))</span><span class="w">
</span><span class="o">|</span><span class="w"> </span><span class="n">where</span><span class="w"> </span><span class="nx">DeviceName</span><span class="w"> </span><span class="nx">contains</span><span class="w"> </span><span class="nx">device</span><span class="w">
</span><span class="o">|</span><span class="w"> </span><span class="n">where</span><span class="w"> </span><span class="nx">ProcessId</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="nx">or</span><span class="w"> </span><span class="nx">InitiatingProcessId</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">pid</span><span class="w">
</span><span class="o">|</span><span class="w"> </span><span class="n">project</span><span class="w"> </span><span class="nx">Timestamp</span><span class="p">,</span><span class="w"> </span><span class="nx">FileName</span><span class="p">,</span><span class="w">
    </span><span class="n">ProcessCommandLine</span><span class="p">,</span><span class="w">
    </span><span class="n">InitiatingProcessCommandLine</span><span class="p">,</span><span class="w">
    </span><span class="n">ProcessId</span><span class="p">,</span><span class="w">
    </span><span class="n">InitiatingProcessId</span><span class="p">,</span><span class="w">
    </span><span class="n">InitiatingProcessParentId</span><span class="p">,</span><span class="w">
    </span><span class="n">ReportId</span><span class="w">
</span><span class="o">|</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="nx">by</span><span class="w"> </span><span class="nx">Timestamp</span><span class="w"> </span><span class="nx">asc</span><span class="w">
</span></pre></table></code></div></div><p>This in the end gave me some interesting results. <img data-src="/assets/img/posts/2022-05-17/spawn1.jpg" alt="spawn1" data-proofer-ignore> We can see (in green) the parent process cmd.exe spawned two sub processes, once again cmd.exe and one <code class="language-plaintext highlighter-rouge">conhost.exe 0xffffffff -ForceV1</code> we will get back to conhost.exe later</p><p>Of course now I wanted to get an understanding of if this new cmd.exe started something, so I adjusted my hunting query and tried again with this result: <img data-src="/assets/img/posts/2022-05-17/spawn2.jpg" alt="spawn2" data-proofer-ignore></p><h2 id="psexec"><span class="mr-2">PsExec</span><a href="#psexec" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>The executed PsExec commands:</p><pre><code class="language-cmd">PsExec.exe  \\mydevice -accepteula -nobanner -s cmd /c powershell.exe -noninteractive -command "&amp;{Get-MPComputerStatus | Select-Object -Property AntispywareEnabled, AntivirusEnabled, OnAccessProtectionEnabled, RealTimeProtectionEnabled}"
PsExec.exe  \\mydevice -accepteula -nobanner -s cmd /c powershell.exe -noninteractive -command "&amp;{Get-MPComputerStatus | Select-Object -Property AMServiceEnabled, AntispywareEnabled, AntispywareSignatureLastUpdated, AntivirusEnabled, AntivirusSignatureLastUpdated, BehaviorMonitorEnabled, IoavProtectionEnabled, NISEnabled, NISSignatureLastUpdated, OnAccessProtectionEnabled, RealTimeProtectionEnabled, TamperProtectionSource}"
</code></pre><p>Now we are getting somewhere, PSExec was executed, why this was not mentioned in the alert is beyond me. Goes to show that you should not just blindly trust MDE to do its job. But it definitely explains the “suspicious discovery” which MDE was talking about. Reading the commands used is quite easy, someone is trying to get information about the security status of this device. Let’s be honest, if an attacker already is admin, there is no need to use noisy tools like PsExec which every EDR on earth notices.</p><p>So far the flow of process looks a bit like this:</p><script type="text/javascript" src="/assets/js/mermaid.js"></script><div class="mermaid"> %%{init: {"theme": "dark"}}%%; flowchart TD; ex[explorer.exe<br />Running in user context]; cmd1[cmd.exe<br />Running in user context]; ps1[powershell.exe<br />Running in user context]; cmd2[cmd.exe<br />Running in admin context]; conhost[conhost.exe]; cmd3[cmd.exe<br />Running in admin context]; PSExec[PSExec.exe]; PSExec2[PSExec.exe]; ex --&gt; cmd1; cmd1 --&gt; ps1; ps1 --&gt; cmd2; cmd2 --&gt; cmd3; cmd2 --&gt; conhost; cmd3 --&gt; PSExec; cmd3 --&gt; PSExec2;</div><h2 id="conhostexe"><span class="mr-2">conhost.exe</span><a href="#conhostexe" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>And what about <code class="language-plaintext highlighter-rouge">conhost.exe 0xffffffff -ForceV1</code>? I did a bit of research about it and came to no intelligent conclusion whatsoever. Hausec has a good <a href="https://hausec.com/2021/07/26/cobalt-strike-and-tradecraft/">writeup</a> on cobalt strike which has similar behaviour. I had a closer look into this and came across a post in <a href="https://strontic.github.io/xcyclopedia/library/conhost.exe-B577C5F724544F0C677F9C51D9B7B481.html">strontic</a> about this topic which brought me to <a href="https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_cobaltstrike_process_patterns.yml">this</a> Sigma rule. I took the Sigma rule and converted it to KQL with <a href="https://uncoder.io/">uncoder</a>:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="n">DeviceProcessEvents</span><span class="w">
</span><span class="o">|</span><span class="w"> </span><span class="n">where</span><span class="w">
    </span><span class="p">(</span><span class="w">
        </span><span class="p">(</span><span class="n">ProcessCommandLine</span><span class="w"> </span><span class="nx">contains</span><span class="w"> </span><span class="sh">@"\cmd.exe /C whoami" and InitiatingProcessFolderPath startswith @"C:\Temp")
        or
        (
            ProcessCommandLine contains "conhost.exe 0xffffffff -ForceV1" and
            (
                    InitiatingProcessCommandLine contains "/C whoami"
                    or InitiatingProcessCommandLine contains "cmd.exe /C echo"
                    or InitiatingProcessCommandLine contains @" &gt; \\\\.\\pipe"
            )
        )
        or
        (
            (
                ProcessCommandLine contains "cmd.exe /c echo"
                or ProcessCommandLine contains @"&gt; \\\\.\\pipe"
                or ProcessCommandLine contains @"\whoami.exe"
            )
            and InitiatingProcessFolderPath endswith @"\dllhost.exe"
        )
        or
        (
            FolderPath endswith @"\cmd.exe"
            and InitiatingProcessFolderPath endswith @"\runonce.exe"
            and InitiatingProcessCommandLine endswith @"\runonce.exe"
        )
    )
| distinct DeviceName, ProcessCommandLine,InitiatingProcessCommandLine,FolderPath,InitiatingProcessFolderPath
</span></pre></table></code></div></div><p>Running this against our environment, focused on our specific device, I was unable to find any traces, which makes me more or less certain that this has nothing to do with cobalt strike in our case.</p><h2 id="privilege-escalation"><span class="mr-2">Privilege Escalation</span><a href="#privilege-escalation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Now knowing the full path of what happened, I had another look into the “privilege escalation” aspect. The logged-in user went from user to administrator, however as far as I was able to check via UAC, so all is in order. This and the understanding of what was happening, made me feel certain enough of what happened, which enables me to get in touch with the user. The user was able to confirm that they are debugging some issues with the installed endpoint protection which fitted into my view of the matter.</p><h2 id="verdict"><span class="mr-2">Verdict</span><a href="#verdict" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><div class="table-wrapper"><table><thead><tr><th>Indicator<th>Thoughts<th>Verdict<tbody><tr><td>CMD started by User<td>Either compromise of host, or legitimate action by user<td>-10%<tr><td>Powershell started with odd parameters<td>The parameters looks pretty malicious / suspicious<td>+90%<tr><td>Elevation of Privileges via UAC<td>This is very normal behaviour and would indicate that someone has access to both user and admin passwords, unlikely<td>-10%<tr><td>Running of PsExec<td>PsExec is often used for malicious behaviour, but in this case local execution as admin makes no actual sense<td>-10%<tr><td>Explanation by user<td>The Explanation of the user made sense and fit into my perspective of how the alert played out<td>-100%</table></div><p><strong>Verdict: False Positive</strong></p><h2 id="next-steps"><span class="mr-2">Next Steps</span><a href="#next-steps" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Get better processes, it’s no good to use PSExec on a business device in my opinion</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/hunting/'>Hunting</a>, <a href='/categories/mde/'>MDE</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/mde/" class="post-tag no-text-decoration" >mde</a> <a href="/tags/hunting/" class="post-tag no-text-decoration" >hunting</a> <a href="/tags/psexec/" class="post-tag no-text-decoration" >psexec</a> <a href="/tags/false-positive/" class="post-tag no-text-decoration" >false positive</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Powershell and PSExec - About Security&amp;url=https://wilddogone.github.io//posts/Powershell-PSexec/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Powershell and PSExec - About Security&amp;u=https://wilddogone.github.io//posts/Powershell-PSexec/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://wilddogone.github.io//posts/Powershell-PSexec/&amp;text=Powershell and PSExec - About Security" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Debugging_Ingest_Pipelines/">Debugging Elastic Pipelines</a><li><a href="/posts/Elastic_Risk_Model/">Building a Risk Model in Elastic</a><li><a href="/posts/Building_Security/">Building Home Security</a><li><a href="/posts/Elastic_Security/">Building Elastic Security</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/elastic/">elastic</a> <a class="post-tag" href="/tags/howto/">howto</a> <a class="post-tag" href="/tags/hunting/">hunting</a> <a class="post-tag" href="/tags/mde/">mde</a> <a class="post-tag" href="/tags/false-positive/">false positive</a> <a class="post-tag" href="/tags/true-positive/">true positive</a> <a class="post-tag" href="/tags/elastalert/">elastalert</a> <a class="post-tag" href="/tags/m365/">m365</a> <a class="post-tag" href="/tags/psexec/">psexec</a> <a class="post-tag" href="/tags/thehive/">thehive</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Mac-Malware/"><div class="card-body"> <em class="timeago small" data-ts="1652953140" > 2022-05-19 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Mac Malware?</h3><div class="text-muted small"><p> Today we investigate some strange discovery actions by processes on a macbook The Alert In the essence this alert was showing multiple different processes doing very similar actions, for the sake...</p></div></div></a></div><div class="card"> <a href="/posts/Admin_Login_Failure/"><div class="card-body"> <em class="timeago small" data-ts="1653158340" > 2022-05-21 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Unusual number of failed sign-in attempts</h3><div class="text-muted small"><p> Today we investigate some failed logins The Alert Todays alert looks simple enough, failed loggins with the user “Administrator” But very quickly we see some not so good indicator, the login conne...</p></div></div></a></div><div class="card"> <a href="/posts/MS_Forms/"><div class="card-body"> <em class="timeago small" data-ts="1655231940" > 2022-06-14 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Malicious Forms</h3><div class="text-muted small"><p> Today we investigate a very interesting story. A user told us, he noticed his account was sending Microsoft Forms to internal people, and he believes he did not do that. The Alert Usually when a ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <span class="btn btn-outline-primary disabled" prompt="Older"><p>-</p></span> <a href="/posts/Mac-Malware/" class="btn btn-outline-primary" prompt="Newer"><p>Mac Malware?</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://github.com/WildDogOne/">WildDogOne</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/elastic/">elastic</a> <a class="post-tag" href="/tags/howto/">howto</a> <a class="post-tag" href="/tags/hunting/">hunting</a> <a class="post-tag" href="/tags/mde/">mde</a> <a class="post-tag" href="/tags/false-positive/">false positive</a> <a class="post-tag" href="/tags/true-positive/">true positive</a> <a class="post-tag" href="/tags/elastalert/">elastalert</a> <a class="post-tag" href="/tags/m365/">m365</a> <a class="post-tag" href="/tags/psexec/">psexec</a> <a class="post-tag" href="/tags/thehive/">thehive</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
